<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo de Colonias Benito Juárez</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* =========================================
           GLITCH NOIR THEME
           ========================================= */
        :root {
            --bg-primary: #050505;
            --text-primary: #00ff00;
            --text-secondary: #ff00ff;
            --text-error: #ff0033;
            --text-warning: #ffaa00;
            --border-primary: #00ff00;
            --border-secondary: #ff00ff;
            --font-mono: 'Courier New', monospace;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: var(--font-mono);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }

        /* Scanlines Overlay */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: linear-gradient(to bottom,
                    rgba(255, 255, 255, 0),
                    rgba(255, 255, 255, 0) 50%,
                    rgba(0, 0, 0, 0.2) 50%,
                    rgba(0, 0, 0, 0.2));
            background-size: 100% 4px;
            z-index: 9999;
        }

        /* Main Container - Split Layout */
        #app-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            background-color: var(--bg-primary);
        }

        /* Map Section - 60% */
        #map-section {
            width: 60%;
            height: 100%;
            position: relative;
            border-right: 2px solid var(--border-primary);
        }

        #map {
            height: 100%;
            width: 100%;
            filter: hue-rotate(10deg) saturate(0.8);
        }

        /* Control Panel - 40% */
        #control-panel {
            width: 40%;
            height: 100%;
            background-color: rgba(10, 10, 10, 0.95);
            border-left: 2px solid var(--border-primary);
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            animation: border-flicker 4s infinite;
        }

        @keyframes border-flicker {

            0%,
            100% {
                border-color: var(--border-primary);
            }

            50% {
                border-color: #004400;
            }
        }

        /* Header */
        h1 {
            font-size: 1rem;
            border-bottom: 2px solid var(--border-primary);
            padding-bottom: 8px;
            margin: 0 0 16px 0;
            text-shadow: 0 0 8px var(--text-primary);
            letter-spacing: 2px;
            text-align: center;
            text-transform: uppercase;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
            font-size: 0.75rem;
        }

        .stat-box {
            border: 1px solid var(--border-secondary);
            padding: 8px;
            text-align: center;
            background: rgba(255, 0, 255, 0.05);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.65rem;
            display: block;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1rem;
            color: var(--text-primary);
        }

        /* Section Headers */
        .section-header {
            font-size: 0.75rem;
            color: var(--text-secondary);
            border-bottom: 1px dashed #333;
            padding-bottom: 4px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        /* Visited List */
        .visited-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .visited-item {
            font-size: 0.7rem;
            padding: 4px 6px;
            margin-bottom: 4px;
            border-left: 2px solid var(--text-secondary);
            background: rgba(255, 0, 255, 0.1);
        }

        .visited-item-name {
            color: var(--text-primary);
            font-weight: bold;
        }

        .visited-item-cost {
            color: var(--text-error);
            font-size: 0.65rem;
        }

        /* Console Log */
        .console-log {
            flex: 1;
            border-top: 1px solid var(--border-secondary);
            margin-top: 16px;
            padding-top: 8px;
            overflow-y: auto;
            font-size: 0.65rem;
            color: #888;
            background: #000;
            min-height: 100px;
        }

        .log-entry {
            margin-bottom: 4px;
            border-left: 2px solid #333;
            padding-left: 6px;
        }

        .log-error {
            border-left-color: var(--text-error);
            color: var(--text-error);
        }

        .log-success {
            border-left-color: var(--text-primary);
            color: var(--text-primary);
        }

        /* Buttons */
        button {
            background: transparent;
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            padding: 10px 16px;
            font-family: var(--font-mono);
            font-weight: bold;
            font-size: 0.75rem;
            text-transform: uppercase;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        button:hover:not(:disabled) {
            background: var(--text-primary);
            color: #000;
            box-shadow: 0 0 15px var(--text-primary);
        }

        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-danger {
            border-color: var(--text-error);
            color: var(--text-error);
        }

        .btn-danger:hover:not(:disabled) {
            background: var(--text-error);
            color: #000;
        }

        .btn-success {
            border-color: var(--text-primary);
            color: var(--text-primary);
        }

        .btn-success:hover:not(:disabled) {
            background: var(--text-primary);
            color: #000;
            box-shadow: 0 0 15px var(--text-primary);
        }

        /* Leaflet Popup Styling */
        .leaflet-popup-content-wrapper {
            background: rgba(10, 10, 10, 0.95);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            font-family: var(--font-mono);
            font-size: 0.75rem;
        }

        .leaflet-popup-tip {
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid var(--border-primary);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #111;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-primary);
        }

        /* Loading Overlay */
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        #loading.hidden {
            display: none;
        }

        .spinner {
            border: 4px solid #333;
            border-top: 4px solid var(--text-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="scanlines"></div>

    <div id="app-container">
        <!-- Map Section - 60% -->
        <div id="map-section">
            <div id="map"></div>
            <div id="loading" class="hidden">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Control Panel - 40% -->
        <div id="control-panel">
            <h1 id="title">BENITO JUAREZ — DIAGNOSTICO</h1>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-box">
                    <span class="stat-label">XP ACTUAL</span>
                    <span class="stat-value" id="xp-val">---</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">VISITADAS</span>
                    <span class="stat-value" id="visited-val">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">XP GASTADO</span>
                    <span class="stat-value" id="spent-val">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">OBJETIVO</span>
                    <span class="stat-value" id="goal-val">6</span>
                </div>
            </div>

            <!-- Visited Colonies -->
            <div class="section-header">COLONIAS VISITADAS:</div>
            <div class="visited-list" id="visited-list">
                <div style="font-size:0.7rem; color:#666; text-align:center; padding:20px;">
                    Haz clic en una colonia del mapa para visitarla...
                </div>
            </div>

            <!-- Actions -->
            <button id="btn-action" class="btn-danger">ABANDONAR BÚSQUEDA</button>

            <!-- Console Log -->
            <div class="section-header" style="margin-top:16px;">CONSOLE LOG:</div>
            <div class="console-log" id="log-list">
                <div class="log-entry">> Sistema inicializado...</div>
                <div class="log-entry">> Esperando configuración...</div>
            </div>
        </div>
    </div>

    <script>
        // ═══════════════════════════════════════
        // LOAD COLONIAS DATA
        // ═══════════════════════════════════════
        let COLONIAS_DATA = null;

        async function loadColoniasData() {
            try {
                const response = await fetch('https://melvinrecords.gt.tc/resistencia/bj/colonias_data.json');
                COLONIAS_DATA = await response.json();
                log('> Datos de colonias cargados.', 'success');
            } catch (error) {
                console.error('[BJ] Error loading colonias_data.json:', error);
                log('> ERROR: No se pudieron cargar los datos de colonias.', 'error');
            }
        }

        // ═══════════════════════════════════════
        // STATE
        // ═══════════════════════════════════════
        let appConfig = null;
        let map, currentPopup = null;

        let playerXP = 0;
        let playerInventory = [];
        let initialXP = 0;
        let totalXPSpent = 0;
        let visitedColonies = [];
        let rejectionCount = 0;
        let isGameActive = false;
        let lastColoniaData = null; // Track last clicked colonia data for popup

        let successRecompensaId = null;
        let failureRecompensaId = null;

        // ═══════════════════════════════════════
        // DOM ELEMENTS
        // ═══════════════════════════════════════
        const xpVal = document.getElementById('xp-val');
        const visitedVal = document.getElementById('visited-val');
        const spentVal = document.getElementById('spent-val');
        const goalVal = document.getElementById('goal-val');
        const visitedList = document.getElementById('visited-list');
        const logList = document.getElementById('log-list');
        const btnAction = document.getElementById('btn-action');

        const FULL_KML_URL = 'https://atogaijnlssrgkvilsyp.supabase.co/storage/v1/object/public/videos/bj.kml';

        const FALLBACK_POLYGONS = [
            { name: 'Narvarte Poniente', coords: [[19.400, -99.170], [19.400, -99.165], [19.395, -99.165], [19.395, -99.170], [19.400, -99.170]] },
            { name: 'Narvarte Oriente', coords: [[19.402, -99.165], [19.402, -99.160], [19.397, -99.160], [19.397, -99.165], [19.402, -99.165]] },
            { name: 'Del Valle Centro', coords: [[19.390, -99.160], [19.390, -99.155], [19.385, -99.155], [19.385, -99.160], [19.390, -99.160]] },
        ];

        // Sanitizador (Sin cambios)
        function sanitizeKML(xmlText) {
            if (!xmlText.trim().startsWith('<?xml') && !xmlText.includes('<kml')) return xmlText;
            xmlText = xmlText.replace(/>([^<]+)</g, (match, content) => {
                return '>' + content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;') + '<';
            });
            xmlText = xmlText.replace(/<name>(.*?)<\/name>/gs, (m, c) => `<name>${c.replace(/<[^>]*>/g, '').trim()}</name>`);
            xmlText = xmlText.replace(/<description>(.*?)<\/description>/gs, (m, c) => `<description>${c.replace(/<[^>]*>/g, '').trim()}</description>`);
            xmlText = xmlText.replace(/(\w+)=([^\s"'>]+)/g, (m, attr, val) => {
                if (!val.startsWith('"') && !val.startsWith("'")) return `${attr}="${val.replace(/"/g, '&quot;')}"`;
                return m;
            });
            xmlText = xmlText.replace(/<!--.*?-->/gs, '');
            return xmlText.trim();
        }

        // ═══════════════════════════════════════
        // CALCULATE COST
        // ═══════════════════════════════════════
        function calculateCost(renta) {
            if (renta >= 24000) return 750;
            if (renta >= 21000) return 600;
            if (renta >= 18000) return 450;
            return 350;
        }

        // ═══════════════════════════════════════
        // LOG FUNCTION
        // ═══════════════════════════════════════
        function log(msg, type = 'normal') {
            const div = document.createElement('div');
            div.className = 'log-entry';
            if (type === 'error') div.classList.add('log-error');
            if (type === 'success') div.classList.add('log-success');
            div.textContent = msg;
            logList.appendChild(div);
            logList.scrollTop = logList.scrollHeight;
        }

        // ═══════════════════════════════════════
        // UPDATE UI
        // ═══════════════════════════════════════
        function updateUI() {
            xpVal.textContent = playerXP.toLocaleString();
            visitedVal.textContent = visitedColonies.length;
            spentVal.textContent = totalXPSpent.toLocaleString();
        }

        // ═══════════════════════════════════════
        // ADD VISITED ITEM
        // ═══════════════════════════════════════
        function addVisitedItem(name, cost, renta) {
            if (visitedColonies.length === 1) {
                visitedList.innerHTML = '';
            }

            const item = document.createElement('div');
            item.className = 'visited-item';
            item.innerHTML = `
                <div class="visited-item-name">${name}</div>
                <div class="visited-item-cost">Renta: $${renta.toLocaleString()} | Costo: -${cost} XP</div>
            `;
            visitedList.appendChild(item);
        }

        // ═══════════════════════════════════════
        // SEND RESULT
        // ═══════════════════════════════════════
        function sendResult(status, isExhaustive = false) {
            isGameActive = false;

            let recompensaId;
            if (status === 'success') {
                // Success puede ser normal (14) o exhaustive (15)
                recompensaId = isExhaustive ? 15 : 14;
            } else {
                recompensaId = 16;
            }

            const result = {
                source: 'RentalApp',
                type: 'app-result',
                status: status,
                recompensaId: recompensaId,
                costoXP: -totalXPSpent,
                metadata: {
                    visited_colonies: visitedColonies.map(v => v.name),
                    total_rejections: rejectionCount,
                    avg_rent: visitedColonies.length > 0 ? Math.floor(visitedColonies.reduce((sum, v) => sum + v.renta, 0) / visitedColonies.length) : 0
                },
                message: getCompletionMessage(status, isExhaustive)
            };

            console.log('[BJ] Sending result:', result);
            window.parent.postMessage(result, '*');

            log(`> Exploración ${status}. Total gastado: ${totalXPSpent} XP`, 'success');
        }

        function getCompletionMessage(status, isExhaustive = false) {
            if (status === 'success') {
                if (isExhaustive) {
                    return 'Documentaste el desplazamiento completo de Benito Juárez.';
                } else {
                    return 'Benito Juárez ya no es viable para Pablo.';
                }
            } else {
                return 'Abandonaste la exploración.';
            }
        }

        // Función loadMap (Sin cambios)
        async function loadMap() {
            if (map) {
                map.remove();
            }
            map = L.map('map').setView([19.37, -99.16], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            let polygonCount = 0;
            const allPolys = L.featureGroup();
            let kmlText = null;

            try {
                console.log('[Mapa] Fetching KML from Supabase...');
                const response = await fetch(FULL_KML_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                kmlText = await response.text();

                if (!kmlText.includes('<kml')) throw new Error('No KML');

                kmlText = sanitizeKML(kmlText);
                const doc = new DOMParser().parseFromString(kmlText, 'text/xml');
                const errorNode = doc.querySelector('parsererror');
                if (errorNode) throw new Error('Malformado: ' + errorNode.textContent);

                const networkLink = doc.querySelector('NetworkLink');
                if (networkLink) {
                    console.log('[Mapa] Stub detectado – extrayendo href...');
                    const hrefElem = networkLink.querySelector('href');
                    if (!hrefElem) throw new Error('No <href> en stub');
                    const hrefCDATAText = hrefElem.textContent.trim();
                    const realHref = hrefCDATAText.replace(/^\[CDATA\[(.*)\]\]$/, '$1');

                    const realResponse = await fetch(realHref);
                    if (!realResponse.ok) throw new Error(`Real HTTP ${realResponse.status}`);
                    kmlText = await realResponse.text();
                    kmlText = sanitizeKML(kmlText);
                    const realDoc = new DOMParser().parseFromString(kmlText, 'text/xml');
                    const realError = realDoc.querySelector('parsererror');
                    if (realError) throw new Error('Real malformado: ' + realError.textContent);

                    polygonCount = addPolysFromDoc(realDoc, allPolys);
                } else {
                    console.log('[Mapa] Full KML detectado – parseando direct...');
                    polygonCount = addPolysFromDoc(doc, allPolys);
                }

                if (polygonCount > 0) {
                    const bounds = allPolys.getBounds();
                    if (bounds.isValid()) map.fitBounds(bounds);
                    console.log(`[Mapa] ${polygonCount} polígonos.`);
                } else {
                    throw new Error('No polígonos');
                }
            } catch (error) {
                console.error('[Mapa] Error KML:', error);
                // Fallback
                FALLBACK_POLYGONS.forEach(col => {
                    const poly = L.polygon(col.coords, { color: getRandomColor(), weight: 2, fillOpacity: 0.3 })
                        .bindPopup(`<b>${col.name}</b><br>Click para datos (Fallback).`)
                        .addTo(map)
                        .addTo(allPolys);
                    const center = poly.getBounds().getCenter();
                    poly.on('click', () => {
                        map.panTo(center);
                        loadColoniaData(col.name, center);
                    });
                    polygonCount++;
                });
                const bounds = allPolys.getBounds();
                if (bounds.isValid()) map.fitBounds(bounds);
                else map.setView([19.37, -99.16], 13);
                L.marker([19.37, -99.16]).addTo(map).bindPopup('KML falló. Usa samples.').openPopup();
                console.log(`[Mapa] Fallback: ${polygonCount} polígonos.`);
            }

            if (polygonCount === 0) console.error('Error: 0 polígonos. Ver console.');
        }

        // Función addPolysFromDoc (Sin cambios)
        function addPolysFromDoc(doc, allPolys) {
            let count = 0;
            const placemarks = doc.getElementsByTagNameNS('http://www.opengis.net/kml/2.2', 'Placemark') || doc.getElementsByTagName('Placemark');
            for (let i = 0; i < placemarks.length; i++) {
                let nameElem = placemarks[i].getElementsByTagNameNS('http://www.opengis.net/kml/2.2', 'name')[0] || placemarks[i].getElementsByTagName('name')[0];
                const name = nameElem ? nameElem.textContent.trim() : `Colonia ${i}`;
                let polygonElem = placemarks[i].getElementsByTagNameNS('http://www.opengis.net/kml/2.2', 'Polygon')[0] || placemarks[i].getElementsByTagName('Polygon')[0];
                if (polygonElem) {
                    let coordsElem = polygonElem.getElementsByTagNameNS('http://www.opengis.net/kml/2.2', 'coordinates')[0] || placemarks[i].getElementsByTagName('coordinates')[0];
                    const coordsText = coordsElem ? coordsElem.textContent.trim() : '';
                    const coords = parseKMLCoords(coordsText);
                    if (coords.length > 3) {
                        const poly = L.polygon(coords, { color: getRandomColor(), weight: 2, fillOpacity: 0.3 })
                            .bindPopup(`<b>${name}</b><br>Click para datos.`)
                            .addTo(map)
                            .addTo(allPolys);

                        // Centra el mapa antes de cargar los datos
                        const center = poly.getBounds().getCenter();
                        poly.on('click', () => {
                            map.panTo(center);
                            loadColoniaData(name, center);
                        });

                        count++;
                    }
                }
            }
            return count;
        }

        // Parsear coords (Sin cambios)
        function parseKMLCoords(text) {
            const parsed = text.split(/\s+/)
                .filter(c => c.includes(','))
                .map(c => {
                    const parts = c.split(',');
                    const lng = parseFloat(parts[0]);
                    const lat = parseFloat(parts[1]);
                    return (isFinite(lat) && isFinite(lng) && lat > 18 && lat < 20 && lng > -100 && lng < -99) ? [lat, lng] : null;
                })
                .filter(Boolean);
            return parsed;
        }

        // Color random (Sin cambios)
        function getRandomColor() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // On-click: Fetch data (Sin cambios)
        async function loadColoniaData(name, center) {
            if (currentPopup) currentPopup.remove();
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('popup-message').textContent = `Cargando datos para ${name}...`;

            const referenceValues = {
                salarioIngeniero: 30000,
                salarioArtista: playerXP
            };

            const context = {
                location: `${name} Benito Juárez CDMX`,
                topics: ['renta promedio', 'aumento plusvalia', 'gentrificacion'],
                referenceValues
            };

            const contextString = encodeURIComponent(JSON.stringify(context));
            const endpoint = `${BASE_API_URL}?context=${contextString}`;

            try {
                const res = await fetch(endpoint);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                lastColoniaData = { name, data };
                showColoniaPopup(name, data, center);
            } catch (error) {
                console.error(`[Mapa] Error para ${name}:`, error);
                const mockData = {
                    mapaData: { titulo: 'Aumento de Plusvalía', valor: '+15%' },
                    censoData: { titulo: 'Nivel de Gentrificación', valor: 'Medio' },
                    graficaData: {
                        renta: 18000,
                        artista: playerXP,
                        ingeniero: 30000
                    }
                };
                lastColoniaData = { name, data: mockData };
                showColoniaPopup(name, mockData, center);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // ═══════════════════════════════════════
        // LOAD COLONIA DATA (WITH COST SYSTEM)
        // ═══════════════════════════════════════
        async function loadColoniaData(name, center) {
            if (!isGameActive) {
                log('> El juego no está activo.', 'error');
                return;
            }

            // Check if already visited
            if (visitedColonies.some(v => v.name === name)) {
                log(`> Ya visitaste ${name}.`, 'error');
                alert(`Ya visitaste ${name}. No puedes visitar la misma colonia dos veces.`);
                return;
            }

            // Get colonia data
            const coloniaData = COLONIAS_DATA ? COLONIAS_DATA[name] : null;

            if (!coloniaData) {
                log(`> No hay datos para ${name}.`, 'error');
                return;
            }

            const renta = coloniaData.graficaData.renta;
            const cost = calculateCost(renta);

            // Check if has enough XP
            if (playerXP < cost) {
                log(`> XP insuficiente para visitar ${name}. Necesitas ${cost} XP.`, 'error');
                alert(`No tienes suficiente XP para visitar ${name}.\nCosto: ${cost} XP\nTu XP: ${playerXP} XP`);
                return;
            }

            // Deduct XP
            playerXP -= cost;
            totalXPSpent += cost;

            // Record visit
            visitedColonies.push({
                name: name,
                renta: renta,
                cost: cost
            });

            // Update UI
            updateUI();
            addVisitedItem(name, cost, renta);

            // Determine event message
            let eventMessage = '';
            if (renta >= 24000) {
                eventMessage = 'El casero ni siquiera te recibe. Gastos de viaje totalmente perdidos.';
                rejectionCount++;
            } else if (renta >= 21000) {
                eventMessage = 'Depósito de 6 meses. Gastos en transporte, comida, solicitud.';
                rejectionCount++;
            } else if (renta >= 18000) {
                eventMessage = 'Lista de espera de 4 meses. Gastos en transporte y trámites.';
                rejectionCount++;
            } else {
                eventMessage = 'Podrías aplicar, pero requieren aval. Gastos de exploración: transporte, comida, copias.';
            }

            // Special events
            if ((name === 'NARVARTE PONIENTE' || name === 'NARVARTE ORIENTE') && visitedColonies.length === 1) {
                eventMessage = 'Regresas a Narvarte. Los recuerdos pesan. Gastos en transporte y comida mientras recorres tu antigua colonia.';
            }

            // Log event
            log(`> ${name}: ${eventMessage}`, 'normal');
            log(`> Costo: -${cost} XP | XP restante: ${playerXP}`, 'normal');

            // Show popup with data
            showColoniaPopup(name, coloniaData, center);

            // Check completion
            checkCompletion();
        }

        function checkCompletion() {
            const goal = appConfig?.gameplay?.coloniasToVisitGoal || 6;

            console.log('[DEBUG checkCompletion] Visited colonies:', visitedColonies.length, 'Goal:', goal);
            console.log('[DEBUG checkCompletion] btnAction element:', btnAction);

            if (visitedColonies.length >= goal) {
                // Change button to "Complete" mode
                console.log('[DEBUG] Changing button to CONCLUIR mode');
                btnAction.textContent = 'CONCLUIR BÚSQUEDA';
                btnAction.classList.remove('btn-danger');
                btnAction.classList.add('btn-success');
                log('> Objetivo alcanzado. Puedes concluir la exploración exitosamente.', 'success');
            } else {
                // Keep button in "Abandon" mode
                console.log('[DEBUG] Keeping button in ABANDONAR mode');
                btnAction.textContent = 'ABANDONAR BÚSQUEDA';
                btnAction.classList.remove('btn-success');
                btnAction.classList.add('btn-danger');
            }
        }

        // Button handler
        btnAction.onclick = () => {
            const goal = appConfig?.gameplay?.coloniasToVisitGoal || 6;

            if (visitedColonies.length >= goal) {
                // Success path: 6-9 = normal (recompensaId 14), 10+ = exhaustive (recompensaId 15)
                const isExhaustive = visitedColonies.length >= 10;
                sendResult('success', isExhaustive);
            } else {
                // Failure path (<6 colonies)
                if (confirm('¿Seguro que quieres abandonar la exploración? Esto tendrá penalizaciones.')) {
                    sendResult('failure');
                }
            }
        };

        // Función showColoniaPopup (Sin cambios en layout)
        function showColoniaPopup(coloniaName, data, center) {
            const graficaData = data.graficaData || { renta: 15000, artista: playerXP, ingeniero: 30000 };
            const mapaData = data.mapaData || { valor: '+10%' };
            const censoData = data.censoData || { valor: 'Medio' };

            const maxRef = Math.max(graficaData.renta, graficaData.artista, graficaData.ingeniero, 1);
            const percentRenta = (graficaData.renta / maxRef) * 100;
            const percentArtista = (graficaData.artista / maxRef) * 100;
            const percentIngeniero = (graficaData.ingeniero / maxRef) * 100;

            const popupContent = `
                <div class="p-2 max-w-xs">
                    <h4 class="font-bold text-lg mb-2 text-center text-purple-300">${coloniaName}</h4>
                    <div class="flex justify-between text-sm mb-2">
                        <div>
                            <span class="text-gray-400">Plusvalía:</span>
                            <span class="font-bold text-green-400 ml-1">${mapaData.valor}</span>
                        </div>
                        <div>
                            <span class="text-gray-400">Gentrificación:</span>
                            <span class="font-bold ml-1 gentrificacion-badge ${censoData.valor.toLowerCase()}">${censoData.valor}</span>
                        </div>
                    </div>
                    <hr class="border-gray-600 mb-2">
                    <div class="space-y-1 text-sm">
                        <div>
                            <div class="flex justify-between">
                                <span class="font-semibold text-red-400">Renta Promedio</span>
                                <span class="font-bold text-red-300">$${graficaData.renta.toLocaleString('es-MX')}</span>
                            </div>
                            <div class="bar-container mb-1"><div class="bar-fill bg-red-500" style="width: ${percentRenta}%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between">
                                <span class="font-semibold text-blue-400">Tus XP (Artista)</span>
                                <span class="font-bold text-blue-300">${graficaData.artista.toLocaleString('es-MX')} XP</span>
                            </div>
                            <div class="bar-container mb-1"><div class="bar-fill bg-blue-500" style="width: ${percentArtista}%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between">
                                <span class="font-semibold text-green-400">Ingeniero (Ref)</span>
                                <span class="font-bold text-green-300">$${graficaData.ingeniero.toLocaleString('es-MX')}</span>
                            </div>
                            <div class="bar-container"><div class="bar-fill bg-green-500" style="width: ${percentIngeniero}%"></div></div>
                        </div>
                    </div>
                    <p class="text-xs text-center mt-2 text-gray-400">Datos 2024-2025 via IA.</p>
                </div>
            `;

            const panPadding = L.point(50, 50);
            currentPopup = L.popup({
                closeButton: true,
                maxWidth: 320,
                autoPan: true,
                autoPanPadding: panPadding
            }).setLatLng(center).setContent(popupContent).openOn(map);
        }

        // ═══════════════════════════════════════
        // MESSAGE LISTENER & INIT
        // ═══════════════════════════════════════
        window.addEventListener('message', async (event) => {
            if (event.data?.source === 'FlujoNarrativoUsuario' && event.data.appData) {
                console.log('[BJ] Configuración recibida:', event.data);

                appConfig = JSON.parse(event.data.appData);

                // Player stats
                if (event.data.playerStats) {
                    playerXP = event.data.playerStats.puntuacion || 0;
                    initialXP = playerXP;
                    playerInventory = event.data.playerStats.inventario || [];
                }

                // Reward IDs
                successRecompensaId = event.data.successRecompensaId;
                failureRecompensaId = event.data.failureRecompensaId;

                // Load colonias data
                await loadColoniasData();

                // Init game
                isGameActive = true;
                goalVal.textContent = appConfig.gameplay?.coloniasToVisitGoal || 6;
                updateUI();
                checkCompletion(); // Initialize button state
                log('> Exploración iniciada. Haz clic en una colonia del mapa para visitarla.', 'success');

                // Load map
                loadMap();
            }
        });

        // --- MODO PRUEBA (MODIFICADO) ---
        // Se añade 'buttonText': 'Cerrar Observatorio' para que el comportamiento
        // local sea idéntico al comportamiento incrustado.
        if (window.parent === window) {
            console.log("[Mapa] Modo de prueba (sin parent) activado.");
            const mockConfig = {
                source: 'FlujoNarrativoUsuario',
                appData: '{"title":"Mapa Interactivo","message":"Click en una colonia para datos.","buttonText":"Cerrar Observatorio"}',
                playerStats: {
                    puntuacion: 15000,
                    inventario: [{ nombre: "item_prueba", descripcion: "..." }]
                }
            };
            window.postMessage(mockConfig, '*');
        }
    </script>
</body>

</html>