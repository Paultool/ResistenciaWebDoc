<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo de Colonias Benito Juárez</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* =========================================
           GLITCH NOIR THEME
           ========================================= */
        :root {
            --bg-primary: #050505;
            --text-primary: #00ff00;
            --text-secondary: #ff00ff;
            --text-error: #ff0033;
            --text-warning: #ffaa00;
            --border-primary: #00ff00;
            --border-secondary: #ff00ff;
            --font-mono: 'Courier New', monospace;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: var(--font-mono);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }

        /* Scanlines Overlay */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: linear-gradient(to bottom,
                    rgba(255, 255, 255, 0),
                    rgba(255, 255, 255, 0) 50%,
                    rgba(0, 0, 0, 0.2) 50%,
                    rgba(0, 0, 0, 0.2));
            background-size: 100% 4px;
            z-index: 9999;
        }

        /* Main Container - Split Layout */
        #app-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            background-color: var(--bg-primary);
        }

        /* Map Section - 60% */
        #map-section {
            width: 60%;
            height: 100%;
            position: relative;
            border-right: 2px solid var(--border-primary);
        }

        #map {
            height: 100%;
            width: 100%;
            filter: hue-rotate(10deg) saturate(0.8);
        }

        /* Control Panel - 40% */
        #control-panel {
            width: 40%;
            height: 100%;
            background-color: rgba(10, 10, 10, 0.95);
            border-left: 2px solid var(--border-primary);
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            animation: border-flicker 4s infinite;
        }

        @keyframes border-flicker {

            0%,
            100% {
                border-color: var(--border-primary);
            }

            50% {
                border-color: #004400;
            }
        }

        /* Header */
        h1 {
            font-size: 1rem;
            border-bottom: 2px solid var(--border-primary);
            padding-bottom: 8px;
            margin: 0 0 16px 0;
            text-shadow: 0 0 8px var(--text-primary);
            letter-spacing: 2px;
            text-align: center;
            text-transform: uppercase;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
            font-size: 0.75rem;
        }

        .stat-box {
            border: 1px solid var(--border-secondary);
            padding: 8px;
            text-align: center;
            background: rgba(255, 0, 255, 0.05);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.65rem;
            display: block;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1rem;
            color: var(--text-primary);
        }

        /* Section Headers */
        .section-header {
            font-size: 0.75rem;
            color: var(--text-secondary);
            border-bottom: 1px dashed #333;
            padding-bottom: 4px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        /* Visited List */
        .visited-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .visited-item {
            font-size: 0.7rem;
            padding: 4px 6px;
            margin-bottom: 4px;
            border-left: 2px solid var(--text-secondary);
            background: rgba(255, 0, 255, 0.1);
        }

        .visited-item-name {
            color: var(--text-primary);
            font-weight: bold;
        }

        .visited-item-cost {
            color: #ffd700;
            /* Gold/Yellow for better contrast */
            font-size: 0.65rem;
        }

        /* Console Log */
        .console-log {
            flex: 1;
            border-top: 1px solid var(--border-secondary);
            margin-top: 16px;
            padding-top: 8px;
            overflow-y: auto;
            font-size: 0.65rem;
            color: #888;
            background: #000;
            min-height: 100px;
        }

        .log-entry {
            margin-bottom: 4px;
            border-left: 2px solid #333;
            padding-left: 6px;
        }

        .log-error {
            border-left-color: var(--text-error);
            color: var(--text-error);
        }

        .log-success {
            border-left-color: var(--text-primary);
            color: var(--text-primary);
        }

        /* Buttons */
        button {
            background: transparent;
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            padding: 10px 16px;
            font-family: var(--font-mono);
            font-weight: bold;
            font-size: 0.75rem;
            text-transform: uppercase;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        button:hover:not(:disabled) {
            background: var(--text-primary);
            color: #000;
            box-shadow: 0 0 15px var(--text-primary);
        }

        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-danger {
            border-color: var(--text-error);
            color: var(--text-error);
        }

        .btn-danger:hover:not(:disabled) {
            background: var(--text-error);
            color: #000;
        }

        .btn-success {
            border-color: var(--text-primary);
            color: var(--text-primary);
        }

        .btn-success:hover:not(:disabled) {
            background: var(--text-primary);
            color: #000;
            box-shadow: 0 0 15px var(--text-primary);
        }

        /* Leaflet Popup Styling */
        .leaflet-popup-content-wrapper {
            background: rgba(10, 10, 10, 0.95);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            font-family: var(--font-mono);
            font-size: 0.75rem;
        }

        .leaflet-popup-tip {
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid var(--border-primary);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #111;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-primary);
        }

        /* Custom Notification Overlay */
        .notification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            animation: fadeIn 0.2s ease-in;
        }

        .notification-box {
            background: rgba(10, 10, 10, 0.95);
            border: 2px solid var(--border-primary);
            padding: 24px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
            animation: glitchIn 0.3s ease-out;
        }

        .notification-box.error {
            border-color: var(--text-error);
            box-shadow: 0 0 30px rgba(255, 0, 51, 0.3);
        }

        .notification-box.warning {
            border-color: var(--text-warning);
            box-shadow: 0 0 30px rgba(255, 170, 0, 0.3);
        }

        .notification-title {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-primary);
        }

        .notification-box.error .notification-title {
            color: var(--text-error);
        }

        .notification-box.warning .notification-title {
            color: var(--text-warning);
        }

        .notification-message {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .notification-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .notification-btn {
            background: transparent;
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            padding: 10px 20px;
            font-family: var(--font-mono);
            font-weight: bold;
            font-size: 0.75rem;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notification-btn:hover {
            background: var(--text-primary);
            color: #000;
            box-shadow: 0 0 15px var(--text-primary);
        }

        .notification-btn.danger {
            border-color: var(--text-error);
            color: var(--text-error);
        }

        .notification-btn.danger:hover {
            background: var(--text-error);
            color: #000;
            box-shadow: 0 0 15px var(--text-error);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes glitchIn {
            0% {
                transform: translate(-2px, 2px);
                opacity: 0;
            }

            25% {
                transform: translate(2px, -2px);
            }

            50% {
                transform: translate(-1px, 1px);
            }

            75% {
                transform: translate(1px, -1px);
            }

            100% {
                transform: translate(0, 0);
                opacity: 1;
            }
        }

        /* =========================================
           MOBILE RESPONSIVE STYLES
           ========================================= */
        @media (max-width: 768px) {

            /* Change to vertical layout on mobile */
            #app-container {
                flex-direction: column;
            }

            /* Map section - reduced to 45% to give more room to controls if needed, or keep 50/50 */
            #map-section {
                width: 100%;
                height: 45vh;
                border-right: none;
                border-bottom: 2px solid var(--border-primary);
            }

            /* Control panel - 55% */
            #control-panel {
                width: 100%;
                height: 55vh;
                border-left: none;
                border-top: 2px solid var(--border-primary);
                padding: 8px;
                /* Reduced padding */
                display: flex;
                flex-direction: column;
            }

            /* Ultra compact header */
            h1 {
                font-size: 0.55rem;
                /* Extremely small for mobile */
                padding-bottom: 2px;
                margin: 0 0 4px 0;
                /* Reduced margin */
                letter-spacing: 0.5px;
            }

            /* Stats grid - 4 columns to save vertical space */
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 4px;
                margin-bottom: 8px;
                font-size: 0.65rem;
            }

            .stat-box {
                padding: 4px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            .stat-label {
                font-size: 0.5rem;
                margin-bottom: 0;
                line-height: 1;
            }

            .stat-value {
                font-size: 0.75rem;
                line-height: 1.2;
            }

            /* Section headers */
            .section-header {
                font-size: 0.65rem;
                padding-bottom: 2px;
                margin-bottom: 4px;
                margin-top: 4px;
                /* Reduced margin top */
            }

            /* Visited list - Flexible height but constrained */
            .visited-list {
                flex: 1;
                /* Take available space */
                min-height: 0;
                /* Allow shrinking */
                max-height: none;
                /* Remove fixed height */
                margin-bottom: 8px;
                background: rgba(0, 0, 0, 0.2);
            }

            .visited-item {
                font-size: 0.6rem;
                padding: 2px 4px;
                margin-bottom: 2px;
                border-left-width: 2px;
            }

            /* Console log - Small and compact at bottom */
            .console-log {
                margin-top: 0;
                height: 50px;
                /* Fixed small height */
                min-height: 50px;
                flex: 0 0 50px;
                font-size: 0.55rem;
                margin-bottom: 8px;
            }

            /* Buttons */
            button {
                padding: 8px;
                font-size: 0.75rem;
                margin-bottom: 0;
                /* Last item usually */
                min-height: 36px;
                /* Slightly smaller than 44px if needed for space, but kept usable */
                flex: 0 0 auto;
            }

            /* Notification adjustments */
            .notification-box {
                padding: 16px;
                margin: 0 10px;
            }
        }

        /* Landscape mode on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            #app-container {
                flex-direction: row;
            }

            #map-section {
                width: 55%;
                height: 100vh;
                border-right: 2px solid var(--border-primary);
                border-bottom: none;
            }

            #control-panel {
                width: 45%;
                height: 100vh;
                border-top: none;
                border-left: 2px solid var(--border-primary);
            }
        }

        /* Loading Overlay */
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        #loading.hidden {
            display: none;
        }

        .spinner {
            border: 4px solid #333;
            border-top: 4px solid var(--text-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="scanlines"></div>

    <div id="app-container">
        <!-- Map Section - 60% -->
        <div id="map-section">
            <div id="map"></div>
            <div id="loading" class="hidden">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Control Panel - 40% -->
        <div id="control-panel">
            <h1 id="title">BENITO JUAREZ — DIAGNOSTICO</h1>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-box">
                    <span class="stat-label">XP ACTUAL</span>
                    <span class="stat-value" id="xp-val">---</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">VISITADAS</span>
                    <span class="stat-value" id="visited-val">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">XP GASTADO</span>
                    <span class="stat-value" id="spent-val">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">OBJETIVO</span>
                    <span class="stat-value" id="goal-val">6</span>
                </div>
            </div>

            <!-- Actions -->
            <button id="btn-action" class="btn-danger">ABANDONAR BÚSQUEDA</button>

            <!-- Console Log -->
            <div class="section-header" style="margin-top:16px;" id="hdr-console">CONSOLE LOG:</div>
            <div class="console-log" id="log-list">
                <div class="log-entry" id="log-init">> Sistema inicializado...</div>
                <div class="log-entry" id="log-wait">> Esperando configuración...</div>
            </div>

            <!-- Visited Colonias -->
            <div class="section-header" style="margin-top:16px;" id="hdr-visited">COLONIAS VISITADAS:</div>
            <div class="visited-list" id="visited-list">
                <div style="font-size:0.7rem; color:#666; text-align:center; padding:20px;" id="visited-placeholder">
                    Haz clic en una colonia del mapa para visitarla...
                </div>
            </div>
        </div>
    </div>

    <script>
        // ═══════════════════════════════════════
        // LOAD COLONIAS DATA
        // ═══════════════════════════════════════
        let COLONIAS_DATA = null;

        async function loadColoniasData() {
            // ... fetch logic omitted for brevity if no changes needed there specifically, assuming loadColoniasData stays same log message logic
            // Actually, I should allow it to be untouched or override logs inside it? 
            // The method uses `log` which handles string. I'll translate the strings inside it manually or just leave as is since it's initial load.
            // Let's replace the whole function to translate logs.
            try {
                const response = await fetch('https://melvinrecords.gt.tc/resistencia/bj/colonias_data.json');
                COLONIAS_DATA = await response.json();
                log(t('logs.dataLoaded'), 'success');
            } catch (error) {
                console.error('[BJ] Error loading colonias_data.json:', error);
                log(t('logs.dataError'), 'error');
            }
        }

        // ═══════════════════════════════════════
        // STATE
        // ═══════════════════════════════════════
        let appConfig = null;
        let map, currentPopup = null;

        let playerXP = 0;
        let playerInventory = [];
        let initialXP = 0;
        let totalXPSpent = 0;
        let visitedColonies = [];
        let rejectionCount = 0;
        let isGameActive = false;
        let lastColoniaData = null; // Track last clicked colonia data for popup

        let successRecompensaId = null;
        let failureRecompensaId = null;
        let currentLanguage = 'es';

        const translations = {
            es: {
                title: "BENITO JUAREZ — DIAGNOSTICO",
                stats: { xp: "XP ACTUAL", visited: "VISITADAS", spent: "XP GASTADO", goal: "OBJETIVO" },
                btnQuit: "ABANDONAR BÚSQUEDA",
                btnFinish: "CONCLUIR BÚSQUEDA",
                headers: { console: "CONSOLE LOG:", visited: "COLONIAS VISITADAS:" },
                placeholders: { visited: "Haz clic en una colonia del mapa para visitarla..." },
                logs: {
                    init: "> Sistema inicializado...",
                    wait: "> Esperando configuración...",
                    start: "> Exploración iniciada. Haz clic en una colonia del mapa para visitarla.",
                    dataLoaded: "> Datos de colonias cargados.",
                    dataError: "> ERROR: No se pudieron cargar los datos de colonias.",
                    inactive: "> El juego no está activo.",
                    alreadyVisited: "> Ya visitaste ",
                    noData: "> No hay datos para ",
                    noXP: "> XP insuficiente para visitar ",
                    success: "> Objetivo alcanzado. Puedes concluir la exploración exitosamente.",
                    event1: "El casero ni siquiera te recibe. Gastos de viaje totalmente perdidos.",
                    event2: "Depósito de 6 meses. Gastos en transporte, comida, solicitud.",
                    event3: "Lista de espera de 4 meses. Gastos en transporte y trámites.",
                    event4: "Podrías aplicar, pero requieren aval. Gastos de exploración: transporte, comida, copias.",
                    eventSpecial: "Regresas a Narvarte. Los recuerdos pesan. Gastos en transporte y comida mientras recorres tu antigua colonia."
                },
                popup: {
                    plusvalia: "Plusvalía:",
                    gentrification: "Gentrificación:",
                    rent: "Renta Promedio",
                    xp: "Tus XP (Artista)",
                    engineer: "Ingeniero (Ref)",
                    footer: "Datos 2024-2025 via IA.",
                    titles: {
                        rent: "Renta Promedio",
                        plus: "Aumento de Plusvalía",
                        gent: "Nivel de Gentrificación"
                    }
                },
                notifications: {
                    visitedTitle: "COLONIA YA VISITADA",
                    visitedMsg: "Ya visitaste {name}. No puedes visitar la misma colonia dos veces.",
                    xpTitle: "XP INSUFICIENTE",
                    xpMsg: "No tienes suficiente XP para visitar {name}.\nCosto: {cost} XP\nTu XP actual: {current} XP",
                    abandonTitle: "ABANDONAR BÚSQUEDA",
                    abandonMsg: "¿Seguro que quieres abandonar la exploración? Esto tendrá penalizaciones.",
                    cancel: "CANCELAR",
                    abandon: "ABANDONAR"
                },
                completion: {
                    successExhaustive: "Documentaste el desplazamiento completo de Benito Juárez.",
                    successNormal: "Benito Juárez ya no es viable para Pablo.",
                    failure: "Abandonaste la exploración."
                }
            },
            en: {
                title: "BENITO JUAREZ — DIAGNOSIS",
                stats: { xp: "CURRENT XP", visited: "VISITED", spent: "XP SPENT", goal: "GOAL" },
                btnQuit: "ABANDON BÚSQUEDA", /* Keeping BÚSQUEDA for flavor or translate? Let's translate fully for clarity */
                btnQuit: "ABANDON SEARCH",
                btnFinish: "CONCLUDE SEARCH",
                headers: { console: "CONSOLE LOG:", visited: "VISITED COLONIES:" },
                placeholders: { visited: "Click on a map colony to visit it..." },
                logs: {
                    init: "> System initialized...",
                    wait: "> Waiting for configuration...",
                    start: "> Exploration started. Click on a colony to visit.",
                    dataLoaded: "> Colony data loaded.",
                    dataError: "> ERROR: Could not load colony data.",
                    inactive: "> Game is not active.",
                    alreadyVisited: "> Already visited ",
                    noData: "> No data for ",
                    noXP: "> Insufficient XP to visit ",
                    success: "> Goal reached. You can successfully conclude the exploration.",
                    event1: "Landlord won't even see you. Travel costs totally lost.",
                    event2: "6-month deposit required. Costs: transport, food, application.",
                    event3: "4-month waiting list. Costs: transport and paperwork.",
                    event4: "Could apply, but guarantor needed. Exploration costs: transport, food, copies.",
                    eventSpecial: "You return to Narvarte. Memories weigh heavy. Costs on transport and food while touring your old hood."
                },
                popup: {
                    plusvalia: "Appreciation:",
                    gentrification: "Gentrification:",
                    rent: "Avg Rent",
                    xp: "Your XP (Artist)",
                    engineer: "Engineer (Ref)",
                    footer: "Data 2024-2025 via AI.",
                    titles: {
                        rent: "Avg Rent",
                        plus: "Appreciation Increase",
                        gent: "Gentrification Level"
                    }
                },
                notifications: {
                    visitedTitle: "COLONY VISITED",
                    visitedMsg: "You already visited {name}. You cannot visit the same colony twice.",
                    xpTitle: "INSUFFICIENT XP",
                    xpMsg: "Not enough XP to visit {name}.\nCost: {cost} XP\nCurrent XP: {current} XP",
                    abandonTitle: "ABANDON SEARCH",
                    abandonMsg: "Are you sure you want to abandon exploration? This will have penalties.",
                    cancel: "CANCEL",
                    abandon: "ABANDON"
                },
                completion: {
                    successExhaustive: "You documented the complete displacement of Benito Juarez.",
                    successNormal: "Benito Juarez is no longer viable for Pablo.",
                    failure: "You abandoned the exploration."
                }
            }
        };

        const t = (key) => {
            const keys = key.split('.');
            let val = translations[currentLanguage];
            for (let k of keys) val = val && val[k];
            return val || key;
        };

        // ═══════════════════════════════════════
        // DOM ELEMENTS
        // ═══════════════════════════════════════
        const xpVal = document.getElementById('xp-val');
        const visitedVal = document.getElementById('visited-val');
        const spentVal = document.getElementById('spent-val');
        const goalVal = document.getElementById('goal-val');
        const visitedList = document.getElementById('visited-list');
        const logList = document.getElementById('log-list');
        const btnAction = document.getElementById('btn-action');

        const FULL_KML_URL = 'https://atogaijnlssrgkvilsyp.supabase.co/storage/v1/object/public/videos/bj.kml';

        const FALLBACK_POLYGONS = [
            { name: 'Narvarte Poniente', coords: [[19.400, -99.170], [19.400, -99.165], [19.395, -99.165], [19.395, -99.170], [19.400, -99.170]] },
            { name: 'Narvarte Oriente', coords: [[19.402, -99.165], [19.402, -99.160], [19.397, -99.160], [19.397, -99.165], [19.402, -99.165]] },
            { name: 'Del Valle Centro', coords: [[19.390, -99.160], [19.390, -99.155], [19.385, -99.155], [19.385, -99.160], [19.390, -99.160]] },
        ];

        // Sanitizador (Sin cambios)
        function sanitizeKML(xmlText) {
            if (!xmlText.trim().startsWith('<?xml') && !xmlText.includes('<kml')) return xmlText;
            xmlText = xmlText.replace(/>([^<]+)</g, (match, content) => {
                return '>' + content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;') + '<';
            });
            xmlText = xmlText.replace(/<name>(.*?)<\/name>/gs, (m, c) => `<name>${c.replace(/<[^>]*>/g, '').trim()}</name>`);
            xmlText = xmlText.replace(/<description>(.*?)<\/description>/gs, (m, c) => `<description>${c.replace(/<[^>]*>/g, '').trim()}</description>`);
            xmlText = xmlText.replace(/(\w+)=([^\s"'>]+)/g, (m, attr, val) => {
                if (!val.startsWith('"') && !val.startsWith("'")) return `${attr}="${val.replace(/"/g, '&quot;')}"`;
                return m;
            });
            xmlText = xmlText.replace(/<!--[\s\S]*?--\>/g, '');
            return xmlText.trim();
        }

        // ═══════════════════════════════════════
        // CALCULATE COST
        // ═══════════════════════════════════════
        function calculateCost(renta) {
            if (renta >= 24000) return 750;
            if (renta >= 21000) return 600;
            if (renta >= 18000) return 450;
            return 350;
        }

        // ═══════════════════════════════════════
        // LOG FUNCTION
        // ═══════════════════════════════════════
        function log(msg, type = 'normal') {
            const div = document.createElement('div');
            div.className = 'log-entry';
            if (type === 'error') div.classList.add('log-error');
            if (type === 'success') div.classList.add('log-success');
            div.textContent = msg;
            logList.appendChild(div);
            logList.scrollTop = logList.scrollHeight;
        }

        // ═══════════════════════════════════════
        // CUSTOM NOTIFICATION SYSTEM
        // ═══════════════════════════════════════
        function showNotification(title, message, type = 'info', buttons = [{ text: 'OK', callback: null }]) {
            return new Promise((resolve) => {
                // Create overlay
                const overlay = document.createElement('div');
                overlay.className = 'notification-overlay';

                // Create notification box
                const box = document.createElement('div');
                box.className = `notification-box ${type}`;

                // Title
                const titleEl = document.createElement('div');
                titleEl.className = 'notification-title';
                titleEl.textContent = title;
                box.appendChild(titleEl);

                // Message
                const messageEl = document.createElement('div');
                messageEl.className = 'notification-message';
                messageEl.textContent = message;
                box.appendChild(messageEl);

                // Buttons container
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'notification-buttons';

                buttons.forEach((btn) => {
                    const button = document.createElement('button');
                    button.className = `notification-btn ${btn.danger ? 'danger' : ''}`;
                    button.textContent = btn.text;
                    button.onclick = () => {
                        document.body.removeChild(overlay);
                        if (btn.callback) btn.callback();
                        resolve(btn.value !== undefined ? btn.value : true);
                    };
                    buttonsContainer.appendChild(button);
                });

                box.appendChild(buttonsContainer);
                overlay.appendChild(box);
                document.body.appendChild(overlay);
            });
        }

        // ═══════════════════════════════════════
        // UPDATE UI
        // ═══════════════════════════════════════
        function updateUI(force = false) {
            xpVal.textContent = playerXP.toLocaleString();
            visitedVal.textContent = visitedColonies.length;
            spentVal.textContent = totalXPSpent.toLocaleString();

            if (force) {
                document.getElementById('title').textContent = t('title');

                const boxes = document.querySelectorAll('.stat-box');
                boxes[0].querySelector('.stat-label').textContent = t('stats.xp');
                boxes[1].querySelector('.stat-label').textContent = t('stats.visited');
                boxes[2].querySelector('.stat-label').textContent = t('stats.spent');
                boxes[3].querySelector('.stat-label').textContent = t('stats.goal');

                document.getElementById('hdr-console').textContent = t('headers.console');
                document.getElementById('hdr-visited').textContent = t('headers.visited');

                // Only update placeholder if list is empty
                if (visitedColonies.length === 0) {
                    document.getElementById('visited-placeholder').textContent = t('placeholders.visited');
                }

                // Update Button Text based on state
                checkCompletion();
            }
        }

        // ═══════════════════════════════════════
        // ADD VISITED ITEM
        // ═══════════════════════════════════════
        function addVisitedItem(name, cost, renta) {
            if (visitedColonies.length === 1) {
                visitedList.innerHTML = '';
            }

            const item = document.createElement('div');
            item.className = 'visited-item';
            item.innerHTML = `
                <div class="visited-item-name">${name}</div>
                <div class="visited-item-cost">Renta: $${renta.toLocaleString()} | Costo: -${cost} XP</div>
            `;
            // Insert at the beginning (prepend) so the latest is at the top
            visitedList.prepend(item);
        }

        // ═══════════════════════════════════════
        // SEND RESULT
        // ═══════════════════════════════════════
        function sendResult(status, isExhaustive = false) {
            isGameActive = false;

            let recompensaId;
            if (status === 'success') {
                // Success puede ser normal (14) o exhaustive (15)
                recompensaId = isExhaustive ? 15 : 14;
            } else {
                recompensaId = 16;
            }

            // UNIFIED PROTOCOL: Solo enviar costos operacionales
            // El XP de la recompensa vendrá de la BD
            const totalXpDelta = -totalXPSpent;

            const result = {
                source: 'ResistenciaApp',
                appName: 'BenitoJuarez',
                type: 'app-result',
                status: status,
                recompensaId: recompensaId,
                xpDelta: totalXpDelta, // Solo costos de viaje
                costoXP: totalXpDelta,  // Legacy support
                metadata: {
                    visited_colonies: visitedColonies.map(v => v.name),
                    total_rejections: rejectionCount,
                    avg_rent: visitedColonies.length > 0 ? Math.floor(visitedColonies.reduce((sum, v) => sum + v.renta, 0) / visitedColonies.length) : 0
                },
                message: getCompletionMessage(status, isExhaustive)
            };

            console.log('[BJ] Sending result:', result);
            window.parent.postMessage(result, '*');

            log(`> Exploración ${status}. Total gastado: ${totalXPSpent} XP`, 'success');
        }

        function getCompletionMessage(status, isExhaustive = false) {
            if (status === 'success') {
                if (isExhaustive) {
                    return t('completion.successExhaustive');
                } else {
                    return t('completion.successNormal');
                }
            } else {
                return t('completion.failure');
            }
        }

        // Función loadMap (Sin cambios)
        async function loadMap() {
            if (map) {
                map.remove();
            }
            map = L.map('map').setView([19.37, -99.16], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            let polygonCount = 0;
            const allPolys = L.featureGroup();
            let kmlText = null;

            try {
                console.log('[Mapa] Fetching KML from Supabase...');
                const response = await fetch(FULL_KML_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                kmlText = await response.text();

                if (!kmlText.includes('<kml')) throw new Error('No KML');

                kmlText = sanitizeKML(kmlText);
                const doc = new DOMParser().parseFromString(kmlText, 'text/xml');
                const errorNode = doc.querySelector('parsererror');
                if (errorNode) throw new Error('Malformado: ' + errorNode.textContent);

                const networkLink = doc.querySelector('NetworkLink');
                if (networkLink) {
                    console.log('[Mapa] Stub detectado – extrayendo href...');
                    const hrefElem = networkLink.querySelector('href');
                    if (!hrefElem) throw new Error('No <href> en stub');
                    const hrefCDATAText = hrefElem.textContent.trim();
                    const realHref = hrefCDATAText.replace(/^\[CDATA\[(.*)\]\]$/, '$1');

                    const realResponse = await fetch(realHref);
                    if (!realResponse.ok) throw new Error(`Real HTTP ${realResponse.status}`);
                    kmlText = await realResponse.text();
                    kmlText = sanitizeKML(kmlText);
                    const realDoc = new DOMParser().parseFromString(kmlText, 'text/xml');
                    const realError = realDoc.querySelector('parsererror');
                    if (realError) throw new Error('Real malformado: ' + realError.textContent);

                    polygonCount = addPolysFromDoc(realDoc, allPolys);
                } else {
                    console.log('[Mapa] Full KML detectado – parseando direct...');
                    polygonCount = addPolysFromDoc(doc, allPolys);
                }

                if (polygonCount > 0) {
                    const bounds = allPolys.getBounds();
                    if (bounds.isValid()) map.fitBounds(bounds);
                    console.log(`[Mapa] ${polygonCount} polígonos.`);
                } else {
                    throw new Error('No polígonos');
                }
            } catch (error) {
                console.error('[Mapa] Error KML:', error);
                // Fallback
                FALLBACK_POLYGONS.forEach(col => {
                    const poly = L.polygon(col.coords, { color: getRandomColor(), weight: 2, fillOpacity: 0.3 })
                        .bindPopup(`<b>${col.name}</b><br>Click para datos (Fallback).`)
                        .addTo(map)
                        .addTo(allPolys);
                    const center = poly.getBounds().getCenter();
                    poly.on('click', () => {
                        map.panTo(center);
                        loadColoniaData(col.name, center);
                    });
                    polygonCount++;
                });
                const bounds = allPolys.getBounds();
                if (bounds.isValid()) map.fitBounds(bounds);
                else map.setView([19.37, -99.16], 13);
                L.marker([19.37, -99.16]).addTo(map).bindPopup('KML falló. Usa samples.').openPopup();
                console.log(`[Mapa] Fallback: ${polygonCount} polígonos.`);
            }

            if (polygonCount === 0) console.error('Error: 0 polígonos. Ver console.');
        }

        // Función addPolysFromDoc (Sin cambios)
        function addPolysFromDoc(doc, allPolys) {
            let count = 0;
            const placemarks = doc.getElementsByTagNameNS('http://www.opengis.net/kml/2.2', 'Placemark') || doc.getElementsByTagName('Placemark');
            for (let i = 0; i < placemarks.length; i++) {
                let nameElem = placemarks[i].getElementsByTagNameNS('http://www.opengis.net/kml/2.2', 'name')[0] || placemarks[i].getElementsByTagName('name')[0];
                const name = nameElem ? nameElem.textContent.trim() : `Colonia ${i}`;
                let polygonElem = placemarks[i].getElementsByTagNameNS('http://www.opengis.net/kml/2.2', 'Polygon')[0] || placemarks[i].getElementsByTagName('Polygon')[0];
                if (polygonElem) {
                    let coordsElem = polygonElem.getElementsByTagNameNS('http://www.opengis.net/kml/2.2', 'coordinates')[0] || placemarks[i].getElementsByTagName('coordinates')[0];
                    const coordsText = coordsElem ? coordsElem.textContent.trim() : '';
                    const coords = parseKMLCoords(coordsText);
                    if (coords.length > 3) {
                        const poly = L.polygon(coords, { color: getRandomColor(), weight: 2, fillOpacity: 0.3 })
                            .bindPopup(`<b>${name}</b><br>Click para datos.`)
                            .addTo(map)
                            .addTo(allPolys);

                        // Centra el mapa antes de cargar los datos
                        const center = poly.getBounds().getCenter();
                        poly.on('click', () => {
                            map.panTo(center);
                            loadColoniaData(name, center);
                        });

                        count++;
                    }
                }
            }
            return count;
        }

        // Parsear coords (Sin cambios)
        function parseKMLCoords(text) {
            const parsed = text.split(/\s+/)
                .filter(c => c.includes(','))
                .map(c => {
                    const parts = c.split(',');
                    const lng = parseFloat(parts[0]);
                    const lat = parseFloat(parts[1]);
                    return (isFinite(lat) && isFinite(lng) && lat > 18 && lat < 20 && lng > -100 && lng < -99) ? [lat, lng] : null;
                })
                .filter(Boolean);
            return parsed;
        }

        // Color random (Sin cambios)
        function getRandomColor() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // On-click: Fetch data (Sin cambios)
        // DUPLICATE/LEGACY FUNCTION COMMENTED OUT
        /*
        async function loadColoniaData(name, center) {
            if (currentPopup) currentPopup.remove();
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('popup-message').textContent = `Cargando datos para ${name}...`;

            const referenceValues = {
                salarioIngeniero: 30000,
                salarioArtista: playerXP
            };

            const context = {
                location: `${name} Benito Juárez CDMX`,
                topics: ['renta promedio', 'aumento plusvalia', 'gentrificacion'],
                referenceValues
            };

            const contextString = encodeURIComponent(JSON.stringify(context));
            const endpoint = `${BASE_API_URL}?context=${contextString}`;

            try {
                const res = await fetch(endpoint);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                lastColoniaData = { name, data };
                showColoniaPopup(name, data, center);
            } catch (error) {
                console.error(`[Mapa] Error para ${name}:`, error);
                const mockData = {
                    mapaData: { titulo: t('popup.titles.plus'), valor: '+15%' },
                    censoData: { titulo: t('popup.titles.gent'), valor: 'Medio' },
                    graficaData: {
                        renta: 18000,
                        artista: playerXP,
                        ingeniero: 30000,
                        tituloRenta: t('popup.titles.rent') // Mock titles injection
                    }
                };
                lastColoniaData = { name, data: mockData };
                showColoniaPopup(name, mockData, center);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }
        */

        // ═══════════════════════════════════════
        // LOAD COLONIA DATA (WITH COST SYSTEM)
        // ═══════════════════════════════════════
        async function loadColoniaData(name, center) {
            if (!isGameActive) {
                log(t('logs.inactive'), 'error');
                return;
            }

            // Check if already visited
            if (visitedColonies.some(v => v.name === name)) {
                log(t('logs.alreadyVisited') + name + '.', 'error');
                showNotification(
                    t('notifications.visitedTitle'),
                    t('notifications.visitedMsg').replace('{name}', name),
                    'error'
                );
                return;
            }

            // Get colonia data
            const coloniaData = COLONIAS_DATA ? COLONIAS_DATA[name] : null;

            if (!coloniaData) {
                log(t('logs.noData') + name + '.', 'error');
                return;
            }

            const renta = coloniaData.graficaData.renta;
            const cost = calculateCost(renta);

            // Check if has enough XP
            if (playerXP < cost) {
                log(t('logs.noXP') + `${name}. (${cost} XP).`, 'error');
                showNotification(
                    t('notifications.xpTitle'),
                    t('notifications.xpMsg').replace('{name}', name).replace('{cost}', cost).replace('{current}', playerXP),
                    'error'
                );
                return;
            }

            // Deduct XP
            playerXP -= cost;
            totalXPSpent += cost;

            // Record visit
            visitedColonies.push({
                name: name,
                renta: renta,
                cost: cost
            });

            // Update UI
            updateUI();
            addVisitedItem(name, cost, renta);

            // Determine event message
            let eventMessage = '';
            if (renta >= 24000) {
                eventMessage = t('logs.event1');
                rejectionCount++;
            } else if (renta >= 21000) {
                eventMessage = t('logs.event2');
                rejectionCount++;
            } else if (renta >= 18000) {
                eventMessage = t('logs.event3');
                rejectionCount++;
            } else {
                eventMessage = t('logs.event4');
            }

            // Special events
            if ((name === 'NARVARTE PONIENTE' || name === 'NARVARTE ORIENTE') && visitedColonies.length === 1) {
                eventMessage = t('logs.eventSpecial');
            }

            // Log event
            log(`> ${name}: ${eventMessage}`, 'normal');
            log(`> Costo: -${cost} XP | XP: ${playerXP}`, 'normal');

            // Show popup with data
            showColoniaPopup(name, coloniaData, center);

            // Check completion
            checkCompletion();
        }

        function checkCompletion() {
            const goal = appConfig?.gameplay?.coloniasToVisitGoal || 6;

            console.log('[DEBUG checkCompletion] Visited colonies:', visitedColonies.length, 'Goal:', goal);
            console.log('[DEBUG checkCompletion] btnAction element:', btnAction);

            if (visitedColonies.length >= goal) {
                // Change button to "Complete" mode
                console.log('[DEBUG] Changing button to CONCLUIR mode');
                btnAction.textContent = t('btnFinish');
                btnAction.classList.remove('btn-danger');
                btnAction.classList.add('btn-success');
                log(t('logs.success'), 'success');
            } else {
                // Keep button in "Abandon" mode
                console.log('[DEBUG] Keeping button in ABANDONAR mode');
                btnAction.textContent = t('btnQuit');
                btnAction.classList.remove('btn-success');
                btnAction.classList.add('btn-danger');
            }
        }

        // Button handler
        btnAction.onclick = async () => {
            const goal = appConfig?.gameplay?.coloniasToVisitGoal || 6;

            if (visitedColonies.length >= goal) {
                // Success path: 6-9 = normal (recompensaId 14), 10+ = exhaustive (recompensaId 15)
                const isExhaustive = visitedColonies.length >= 10;
                sendResult('success', isExhaustive);
            } else {
                // Failure path (<6 colonies)
                const confirmed = await showNotification(
                    t('notifications.abandonTitle'),
                    t('notifications.abandonMsg'),
                    'warning',
                    [
                        { text: t('notifications.cancel'), value: false },
                        { text: t('notifications.abandon'), value: true, danger: true }
                    ]
                );
                if (confirmed) {
                    sendResult('failure');
                }
            }
        };

        // Función showColoniaPopup (Sin cambios en layout)
        function showColoniaPopup(coloniaName, data, center) {
            const graficaData = data.graficaData || { renta: 15000, artista: playerXP, ingeniero: 30000 };
            const mapaData = data.mapaData || { valor: '+10%' };
            const censoData = data.censoData || { valor: 'Medio' };

            const maxRef = Math.max(graficaData.renta, graficaData.artista, graficaData.ingeniero, 1);
            const percentRenta = (graficaData.renta / maxRef) * 100;
            const percentArtista = (graficaData.artista / maxRef) * 100;
            const percentIngeniero = (graficaData.ingeniero / maxRef) * 100;

            const popupContent = `
                <div class="p-2 max-w-xs">
                    <h4 class="font-bold text-lg mb-2 text-center text-purple-300">${coloniaName}</h4>
                    <div class="flex justify-between text-sm mb-2">
                        <div>
                            <span class="text-gray-400">${t('popup.plusvalia')}</span>
                            <span class="font-bold text-green-400 ml-1">${mapaData.valor}</span>
                        </div>
                        <div>
                            <span class="text-gray-400">${t('popup.gentrification')}</span>
                            <span class="font-bold ml-1 gentrificacion-badge ${censoData.valor.toLowerCase()}">${censoData.valor}</span>
                        </div>
                    </div>
                    <hr class="border-gray-600 mb-2">
                    <div class="space-y-1 text-sm">
                        <div>
                            <div class="flex justify-between">
                                <span class="font-semibold text-red-400">${t('popup.rent')}</span>
                                <span class="font-bold text-red-300">$${graficaData.renta.toLocaleString('es-MX')}</span>
                            </div>
                            <div class="bar-container mb-1"><div class="bar-fill bg-red-500" style="width: ${percentRenta}%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between">
                                <span class="font-semibold text-blue-400">${t('popup.xp')}</span>
                                <span class="font-bold text-blue-300">${graficaData.artista.toLocaleString('es-MX')} XP</span>
                            </div>
                            <div class="bar-container mb-1"><div class="bar-fill bg-blue-500" style="width: ${percentArtista}%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between">
                                <span class="font-semibold text-green-400">${t('popup.engineer')}</span>
                                <span class="font-bold text-green-300">$${graficaData.ingeniero.toLocaleString('es-MX')}</span>
                            </div>
                            <div class="bar-container"><div class="bar-fill bg-green-500" style="width: ${percentIngeniero}%"></div></div>
                        </div>
                    </div>
                    <p class="text-xs text-center mt-2 text-gray-400">${t('popup.footer')}</p>
                </div>
            `;

            const panPadding = L.point(50, 50);
            currentPopup = L.popup({
                closeButton: true,
                maxWidth: 320,
                autoPan: true,
                autoPanPadding: panPadding
            }).setLatLng(center).setContent(popupContent).openOn(map);
        }

        // ═══════════════════════════════════════
        // MESSAGE LISTENER & INIT
        // ═══════════════════════════════════════
        window.addEventListener('message', async (event) => {
            if (event.data?.source === 'FlujoNarrativoUsuario' && event.data.appData) {
                console.log('[BJ] Configuración recibida:', event.data);

                appConfig = JSON.parse(event.data.appData);

                // Player stats
                if (event.data.playerStats) {
                    playerXP = event.data.playerStats.puntuacion || 0;
                    initialXP = playerXP;
                    playerInventory = event.data.playerStats.inventario || [];
                }

                // Reward IDs
                if (event.data.cc) {
                    currentLanguage = event.data.cc;
                    console.log(`[BJ] Language set to: ${currentLanguage}`);
                }

                successRecompensaId = event.data.successRecompensaId;
                failureRecompensaId = event.data.failureRecompensaId;

                // Load colonias data
                await loadColoniasData();

                // Init game
                isGameActive = true;
                goalVal.textContent = appConfig.gameplay?.coloniasToVisitGoal || 6;
                updateUI(true); // Force full UI update
                checkCompletion(); // Initialize button state
                log(t('logs.start'), 'success');
                document.getElementById('log-init').textContent = t('logs.init');
                document.getElementById('log-wait').textContent = t('logs.sync'); // Sync usually means data loaded or ready

                // Load map
                loadMap();
            }
        });

        // --- MODO PRUEBA (MODIFICADO) ---
        // Se añade 'buttonText': 'Cerrar Observatorio' para que el comportamiento
        // local sea idéntico al comportamiento incrustado.
        if (window.parent === window) {
            console.log("[Mapa] Modo de prueba (sin parent) activado.");
            const mockConfig = {
                source: 'FlujoNarrativoUsuario',
                appData: '{"title":"Mapa Interactivo","message":"Click en una colonia para datos.","buttonText":"Cerrar Observatorio"}',
                playerStats: {
                    puntuacion: 15000,
                    inventario: [{ nombre: "item_prueba", descripcion: "..." }]
                }
            };
            window.postMessage(mockConfig, '*');
        }
        // ═══════════════════════════════════════
        // WINDOW RESIZE HANDLER
        // ═══════════════════════════════════════
        window.addEventListener('resize', () => {
            if (map) {
                setTimeout(() => {
                    map.invalidateSize();
                }, 200);
            }
        });

    </script>
</body>

</html>