<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√∫squeda de Renta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #2c3e50; /* Fondo gris azulado oscuro */
            color: #ecf0f1; /* Texto gris claro */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 0.25rem; /* Padding m√≠nimo para frame */
            text-align: center;
        }

        .card {
            background-color: #34495e; /* Azul medianoche */
            border-radius: 0.5rem; /* Bordes redondeados suaves */
            padding: 0.5rem; /* Padding m√°s compacto */
            max-width: 450px; /* Ancho aumentado para layout horizontal */
            width: 100%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.6); /* Sombra sutil */
            border: 1px solid #f1c40f; /* Borde amarillo acento */
            animation: bounceIn 0.6s ease-out; /* Animaci√≥n de entrada r√°pida */
        }

        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.9); }
            60% { opacity: 1; transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .ad-container {
            display: flex; /* Layout horizontal para anuncio */
            flex-direction: row; /* Elementos lado a lado */
            align-items: center; /* Alineaci√≥n vertical centro */
            margin-bottom: 0.25rem; /* Espacio m√≠nimo abajo */
            gap: 0.5rem; /* Espacio entre imagen y descripci√≥n */
        }

        .text-neon-yellow {
            color: #f1c40f; /* Amarillo ne√≥n para acentos */
        }

        .btn-action {
            background-color: #2ecc71; /* Verde esmeralda */
            color: #2c3e50; /* Texto oscuro */
            font-weight: 600; /* Peso de fuente medio */
            padding: 0.4rem 0.8rem; /* Padding peque√±o */
            border-radius: 0.25rem; /* Bordes suaves */
            transition: background-color 0.3s, transform 0.1s; /* Transiciones suaves */
        }

        .btn-action:hover:not(:disabled) {
            background-color: #27ae60; /* Verde m√°s oscuro en hover */
            transform: translateY(-1px); /* Efecto de elevaci√≥n */
        }

        .btn-action:disabled {
            background-color: #7f8c8d; /* Gris desactivado */
            cursor: not-allowed;
        }

        .btn-close {
            background-color: #e74c3c; /* Rojo alizarina */
        }

        .btn-close:hover:not(:disabled) {
            background-color: #c0392b; /* Rojo m√°s oscuro en hover */
        }

        #ad-image {
            width: 40%; /* Ancho reducido para layout horizontal */
            height: auto; /* Altura autom√°tica */
            border-radius: 0.25rem; /* Bordes suaves */
            border: 1px solid #f1c40f; /* Borde amarillo */
        }

        #ad-description {
            font-size: 0.75rem; /* Tama√±o peque√±o (text-xs) */
            font-style: italic; /* Estilo it√°lico para anuncio */
            flex: 1; /* Ocupa el espacio restante */
            margin: 0; /* Sin m√°rgenes extra */
        }
    </style>
</head>
<body>

    <div id="game-container" class="card">
        <div class="ad-container">
            <img id="ad-image" src="" alt="Anuncio de Departamento">
            <p id="ad-description"></p>
        </div>
        <h1 id="title" class="text-xl font-extrabold mb-1 text-neon-yellow">B√∫squeda de Renta</h1>
        <p id="message" class="mb-2 text-sm"></p>
        
        <div id="countdown-timer" class="mb-1 text-md font-bold"></div>
        
        <div id="action-area" class="flex flex-row justify-between space-x-1">
            <button id="action-btn" class="btn-action flex-1 text-sm" disabled>
                Intentar Negociaci√≥n
            </button>
            <button id="close-btn" class="btn-close flex-1 text-white font-bold py-1 px-2 rounded-md transition-all duration-300 text-sm">
                Cerrar
            </button>
        </div>
        
    </div>

    <script>
        // Lista de 12 inmuebles basados en investigaci√≥n de rentas en Narvarte, CDMX
        // Variados por costo (bajo: 100-300 XP, medio: 301-600, alto: 601-900, premium: 901+) y dificultad (low: √≠tems b√°sicos, medium: intermedios, high: avanzados)
        // Selecci√≥n: Basada en |price| para costo, y si appConfig.difficulty existe ('low','medium','high'), sino inferir de |price|/300
        const inmuebles = [
            // Bajo costo, low difficulty
            { description: 'üè† Departamento compacto de 1 rec√°mara con cocina integral y ba√±o completo en Narvarte Poniente. Ideal para solteros, cerca de parques.', imageUrl: 'https://via.placeholder.com/180x100?text=Depto+1+Rec+Narvarte+Bajo' },
            // Bajo costo, medium
            { description: 'üè† Acogedor depto de 1 rec con balc√≥n peque√±o, elevador y seguridad 24/7 en Narvarte Oriente. Cerca de metro y tiendas.', imageUrl: 'https://via.placeholder.com/180x100?text=Depto+1+Rec+Balc√≥n+Narvarte' },
            // Bajo costo, high
            { description: 'üè† Depto econ√≥mico de 1 rec√°mara amueblado con vista a jard√≠n, estacionamiento techado en Narvarte. Mantenimiento incluido.', imageUrl: 'https://via.placeholder.com/180x100?text=Depto+Amueblado+1+Rec+Narvarte' },
            // Medio costo, low
            { description: 'üè† Espacioso departamento de 2 rec√°maras con 1 ba√±o, cocina equipada y √°rea de lavado en Narvarte Poniente. Cerca de avenidas principales.', imageUrl: 'https://via.placeholder.com/180x100?text=Depto+2+Rec+Narvarte+Medio' },
            // Medio, medium
            { description: 'üè† Moderno depto de 2 rec con balc√≥n, 2 ba√±os y elevador en Narvarte Oriente. Rodeado de restaurantes y parques.', imageUrl: 'https://via.placeholder.com/180x100?text=Depto+2+Rec+Balcon+Narvarte' },
            // Medio, high
            { description: 'üè† Departamento amueblado de 2 rec√°maras con terraza privada de 10m¬≤, seguridad y estacionamiento en Narvarte. Vista verde.', imageUrl: 'https://via.placeholder.com/180x100?text=Depto+2+Rec+Terraza+Narvarte' },
            // Alto costo, low
            { description: 'üè† Amplio depto de 3 rec√°maras con 2 ba√±os, cocina integral y sala comedor en Narvarte Poniente. Cerca de escuelas y transporte.', imageUrl: 'https://via.placeholder.com/180x100?text=Depto+3+Rec+Narvarte+Alto' },
            // Alto, medium
            { description: 'üè† Elegante departamento de 3 rec con balc√≥n panor√°mico, elevador y 2 estacionamientos en Narvarte Oriente. Zona premium.', imageUrl: 'https://via.placeholder.com/180x100?text=Depto+3+Rec+Panoramico+Narvarte' },
            // Alto, high
            { description: 'üè† Lujoso depto amueblado de 3 rec√°maras con terraza, jacuzzi y vista al parque en Narvarte. Seguridad 24/7.', imageUrl: 'https://via.placeholder.com/180x100?text=Depto+3+Rec+Lujoso+Narvarte' },
            // Premium costo, low
            { description: 'üè† Exclusivo penthouse de 4 rec√°maras con roof garden, 3 ba√±os y cocina gourmet en Narvarte Poniente. Alta demanda.', imageUrl: 'https://via.placeholder.com/180x100?text=Penthouse+4+Rec+Narvarte+Premium' },
            // Premium, medium
            { description: 'üè† Departamento premium de 4 rec con terraza amplia, elevador privado y 3 estacionamientos en Narvarte Oriente. Vista espectacular.', imageUrl: 'https://via.placeholder.com/180x100?text=Depto+4+Rec+Terraza+Narvarte' },
            // Premium, high
            { description: 'üè† Magn√≠fico depto de lujo de 4 rec√°maras totalmente amueblado con piscina compartida y gym en Narvarte. Zona elite.', imageUrl: 'https://via.placeholder.com/180x100?text=Depto+Lujo+4+Rec+Narvarte' }
        ];

        // --- Variables globales de configuraci√≥n (seteadas por el parent) ---
        let appConfig = {};
        let playerInventory = [];
        let playerXP = 0; 
        let successRecompensaId = null;
        let failureRecompensaId = null;
        let timerInterval = null;
        let isConfigLoaded = false; // Bandera para evitar doble inicializaci√≥n

        // --- Elementos de la UI (se inicializar√°n en DOMContentLoaded) ---
        let titleEl;
        let messageEl;
        let actionBtn;
        let closeBtn;
        let timerEl;
        let adImageEl;
        let adDescriptionEl;
        let sent = false;  // Flag para prevenir duplicados

        // --- Funci√≥n para obtener elementos del DOM ---
        function initializeDOM() {
            titleEl = document.getElementById('title');
            messageEl = document.getElementById('message');
            actionBtn = document.getElementById('action-btn');
            closeBtn = document.getElementById('close-btn');
            timerEl = document.getElementById('countdown-timer');
            adImageEl = document.getElementById('ad-image');
            adDescriptionEl = document.getElementById('ad-description');
        }

        // --- Funci√≥n para seleccionar inmueble basado en costo y dificultad ---
        function selectInmueble(rentaAbsoluta, difficulty) {
            // Inferir difficulty si no se env√≠a (basado en requiredItem o default 'medium')
            if (!difficulty) {
                difficulty = 'medium'; // Default
                if (appConfig.requiredItem && appConfig.requiredItem.length > 10) difficulty = 'high'; // Ejemplo simple de inferencia
            }
            
            // Mapear difficulty a √≠ndice base: low=0, medium=1, high=2
            const diffIndex = { low: 0, medium: 1, high: 2 }[difficulty] || 1;
            
            // Mapear costo a grupo: bajo=0, medio=1, alto=2, premium=3
            let costGroup = 0;
            if (rentaAbsoluta > 900) costGroup = 3;
            else if (rentaAbsoluta > 600) costGroup = 2;
            else if (rentaAbsoluta > 300) costGroup = 1;
            
            // √çndice final: costGroup * 3 + diffIndex
            const index = costGroup * 3 + diffIndex;
            return inmuebles[index % inmuebles.length]; // Seguridad por si index >11
        }

        // --- Funci√≥n para enviar el resultado al parent (Canvas) ---
        /**
         * @param {('success' | 'failure')} status - Estado del resultado.
         * @param {string} message - Mensaje descriptivo.
         * @param {number} [costoXP=0] - Costo de XP (negativo) o ganancia (positivo).
         */
        function sendResult(status, message, costoXP = 0) {

            if (sent) {
                console.log("[RentalApp] Resultado ya enviado. Ignorando duplicado.");
                return;
            }
            sent = true;
            
            // üõë CR√çTICO 1: Deshabilita TODOS los botones de forma preventiva.
            if(actionBtn) actionBtn.disabled = true;
            if(closeBtn) closeBtn.disabled = true;

            // Detener el intervalo ANTES de enviar el mensaje para cerrar el modal
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            let recompensaId = status === 'success' ? successRecompensaId : failureRecompensaId;

            const result = {
                source: 'RentalApp',
                type: 'app-result',
                status: status,
                recompensaId: recompensaId,
                costoXP: costoXP, // EL COSTO DE RENTA/XP SE ENV√çA AQU√ç (Valor negativo si es costo)
                message: message 
            };
            
            // Env√≠a el mensaje al parent para cerrar el modal y aplicar recompensas/costos.
            window.parent.postMessage(result, '*');


            console.log("[RentalApp] Enviando resultado al parent:", result);  // ‚Üê Agrega esto
            window.parent.postMessage(result, '*');
            
            // üõë CR√çTICO 2: Limpia el contenido del juego para una salida limpia
            // Esto asegura que el iframe quede en un estado 'muerto' despu√©s del resultado.
            const container = document.getElementById('game-container');
            if (container) {
                container.innerHTML = `<p class="text-lg text-neon-yellow">Procesando...</p>`;
            }
        }


        // --- Manejo de la L√≥gica del Juego ---
        
        function handleAction() {
            // Deshabilita el bot√≥n de acci√≥n principal inmediatamente para evitar doble clic.
            actionBtn.disabled = true;
            
            // Detener el temporizador, ya que la acci√≥n se ha tomado
            if (timerInterval) clearInterval(timerInterval);

            const rentaAbsoluta = Math.abs(appConfig.price || 100);
            const rentaXP = -rentaAbsoluta; 

            // 1. **[VERIFICACI√ìN XP]** Revisar si el jugador tiene suficiente XP
            if (playerXP < rentaAbsoluta) {
                setupInsufficientFunds(rentaAbsoluta);
                return;
            }
            
            // 2. Revisar si el jugador tiene el √≠tem requerido
            const hasRequiredItem = playerInventory.some(item => item.nombre === appConfig.requiredItem);


            if (hasRequiredItem) {
                // √âxito: Tiene √≠tem y tiene fondos
                setupSuccess(rentaXP);
            } else {
                // Fallo: Tiene fondos, pero le falta el √≠tem
                setupFailure();
            }
        }

        function setupInitialView() {
            const rentaAbsoluta = Math.abs(appConfig.price || 100);
            titleEl.textContent = "üí∞ Negociaci√≥n de Renta";
            
            // Seleccionar inmueble basado en costo y dificultad (si se env√≠a en appConfig.difficulty)
            const selected = selectInmueble(rentaAbsoluta, appConfig.difficulty);
            adImageEl.src = selected.imageUrl;
            adDescriptionEl.innerHTML = `${selected.description} <br><span style="font-style: normal; font-weight: bold;">Costo: ${rentaAbsoluta.toLocaleString()} XP | Requiere: ${appConfig.requiredItem || 'Ninguno'} | Tus XP: ${playerXP.toLocaleString()} | 30s para decidir.</span>`;

            // Limpiar el mensaje separado para integrar todo en el anuncio
            messageEl.innerHTML = '';

            // Configuraci√≥n inicial de botones
            actionBtn.textContent = "¬°Intentar Negociaci√≥n!";
            actionBtn.disabled = false;
            actionBtn.style.display = 'block';
            actionBtn.onclick = handleAction;

            closeBtn.textContent = "Cancelar (Pierde Oportunidad)";
            closeBtn.disabled = false;
            closeBtn.classList.remove('btn-action');
            closeBtn.classList.add('btn-close');
            closeBtn.onclick = () => sendResult('failure', "Cancelaste la negociaci√≥n.", 0);

            startTimer(30);
        }

        // Se llama si el jugador no tiene suficiente XP
        function setupInsufficientFunds(rentaAbsoluta) {
            titleEl.textContent = "üìâ Fondos Insuficientes";
            messageEl.innerHTML = `No tienes suficiente XP para pagar la renta de **${rentaAbsoluta.toLocaleString()} XP**. Necesitas ahorrar m√°s.`;
            
            // Transici√≥n de botones
            actionBtn.style.display = 'none'; 
            closeBtn.classList.add('btn-close');
            closeBtn.classList.remove('btn-action');
            closeBtn.textContent = "Entendido";
            
            // El bot√≥n "Continuar" llama a sendResult con status 'failure' y costo 0
            closeBtn.onclick = () => sendResult('failure', "Fallo por falta de XP.", 0);
        }


        // Se llama al √©xito con el costo de XP de la renta
        function setupSuccess(rentaXP) {
            titleEl.textContent = "üè† ¬°Departamento Conseguido!";
            messageEl.innerHTML = `¬°Felicidades! La renta te cost√≥ **${Math.abs(rentaXP).toLocaleString()} XP**.`;
            
            // Transici√≥n de botones
            actionBtn.style.display = 'none'; // Ocultar el bot√≥n de acci√≥n
            closeBtn.classList.remove('btn-close');
            closeBtn.classList.add('btn-action');
            closeBtn.textContent = "Continuar";
            
            // El bot√≥n "Continuar" llama a sendResult con status 'success' y el costo de XP
            closeBtn.onclick = () => sendResult('success', "Renta conseguida.", rentaXP);
        }

        function setupFailure() {
            titleEl.textContent = "üö´ Oportunidad Perdida";
            messageEl.innerHTML = `¬°Documentos rechazados! Te falt√≥ **${appConfig.requiredItem}**. Busca en otro lugar.`;
            
            // Transici√≥n de botones
            actionBtn.style.display = 'none'; // Ocultar el bot√≥n de acci√≥n
            closeBtn.classList.add('btn-close');
            closeBtn.classList.remove('btn-action');
            closeBtn.textContent = "Continuar";
            
            // El bot√≥n "Continuar" llama a sendResult con status 'failure' y costo 0
            closeBtn.onclick = () => sendResult('failure', "Renta fallida.", 0);
        }

        // --- Mec√°nica Auxiliar: Temporizador ---
        function startTimer(seconds) {
            let timeLeft = seconds;
            timerEl.innerHTML = `<span id="timer">${timeLeft}</span> segundos restantes`;
            
            timerInterval = setInterval(() => {
                timeLeft -= 1;
                timerEl.innerHTML = `<span id="timer">${timeLeft}</span> segundos restantes`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    // El `sendResult` deshabilita el resto de los botones
                    timerEl.textContent = "¬°Tiempo agotado!";
                    // Se env√≠a el resultado de failure por tiempo agotado
                    sendResult('failure', "Demasiado lento. Te lo ganaron.", 0);
                }
            }, 1000);
        }

        // --- Inicializaci√≥n: Recibir configuraci√≥n del Parent (Asegura que el DOM est√© listo) ---
        window.addEventListener('DOMContentLoaded', () => {
            
            initializeDOM(); // Inicializa las referencias a los elementos del DOM
            window.addEventListener('message', (event) => {
                if (event.data && event.data.source === 'FlujoNarrativoUsuario' && event.data.appData) {
                    
                    // üõë CR√çTICO: Bloquea si ya se recibi√≥ la configuraci√≥n para prevenir doble ejecuci√≥n
                    if (isConfigLoaded) {
                        console.log("[RentalApp] Configuraci√≥n ya cargada. Ignorando mensaje duplicado.");
                        return;
                    }
                    isConfigLoaded = true; // Marca como cargado
                    
                    console.log("[RentalApp] Configuraci√≥n recibida:", event.data);
                    
                    const data = JSON.parse(event.data.appData);
                    appConfig = data;
                    
                    // Mapear el inventario para facilitar la b√∫squeda por nombre
                    playerInventory = event.data.playerStats.inventario.map(item => ({
                        ...item,
                        nombre: item.nombre 
                    }));

                    // OBTENER EL XP DEL JUGADOR
                    playerXP = event.data.playerStats.puntuacion || 0;
                    
                    successRecompensaId = event.data.successRecompensaId;
                    failureRecompensaId = event.data.failureRecompensaId;
                    
                    setupInitialView();
                }
            });
        });

    </script>
</body>
</html>
